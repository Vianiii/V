name: Ubuntu Desktop VNC (Fixed)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  ubuntu-desktop:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h

      - name: Set up /mnt storage
        run: |
          sudo mkdir -p /mnt/storage
          sudo chmod 777 /mnt/storage
          echo "Storage mounted at /mnt/storage"
          df -h /mnt

      - name: Install Desktop Environment & VNC
        run: |
          echo "Installing desktop environment..."
          sudo apt-get update
          
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 \
            xfce4-goodies \
            xfce4-terminal \
            dbus-x11 \
            x11-xserver-utils \
            tigervnc-standalone-server \
            tigervnc-common \
            tigervnc-xorg-extension \
            fonts-liberation \
            firefox \
            nano \
            net-tools \
            wget \
            curl \
            htop
          
          echo "Installation complete!"

      - name: Configure VNC Password and Settings
        run: |
          mkdir -p ~/.vnc
          
          # Set VNC password
          echo "github2024" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          echo "VNC password configured"
          
          # Create optimized xstartup for smooth animations
          cat > ~/.vnc/xstartup << 'EOFVNC'
          #!/bin/bash
          
          # Unset session manager
          unset SESSION_MANAGER
          unset DBUS_SESSION_BUS_ADDRESS
          
          # Setup environment
          export XKL_XMODMAP_DISABLE=1
          export XDG_RUNTIME_DIR=/tmp/runtime-runner
          mkdir -p $XDG_RUNTIME_DIR
          chmod 700 $XDG_RUNTIME_DIR
          
          # Start D-Bus
          if [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then
              eval $(dbus-launch --sh-syntax)
          fi
          
          # Load resources
          [ -r $HOME/.Xresources ] && xrdb $HOME/.Xresources
          xsetroot -solid "#2E3440"
          
          # Start XFCE with compositor for smooth animations
          startxfce4 &
          EOFVNC
          
          chmod +x ~/.vnc/xstartup
          cat ~/.vnc/xstartup
          
          # Create VNC config for optimal settings
          cat > ~/.vnc/config << 'EOFCONFIG'
          geometry=1920x1080
          dpi=96
          depth=24
          localhost=no
          alwaysshared=true
          EOFCONFIG
          
          cat ~/.vnc/config

      - name: Start VNC Server
        run: |
          echo "Starting VNC server..."
          
          # Kill any existing VNC sessions
          vncserver -kill :0 2>/dev/null || true
          sleep 2
          
          # Start VNC on display :0 (port 5900)
          vncserver :0 -geometry 1920x1080 -depth 24 -localhost no
          
          sleep 5
          
          # Verify VNC is running
          echo "=== VNC Process Check ==="
          ps aux | grep -i vnc
          
          echo "=== VNC Port Check ==="
          netstat -tulpn | grep 5900 || ss -tulpn | grep 5900
          
          echo "=== VNC Log ==="
          cat ~/.vnc/*.log 2>/dev/null || echo "No VNC logs found"
          
          # Test VNC locally
          echo "=== Testing VNC locally ==="
          timeout 5 nc -zv localhost 5900 || echo "Local VNC test failed"

      - name: Download and Setup FRP Client
        run: |
          echo "Downloading FRP client..."
          FRP_VERSION="0.60.0"
          wget -q https://github.com/fatedier/frp/releases/download/v${FRP_VERSION}/frp_${FRP_VERSION}_linux_amd64.tar.gz
          tar -xzf frp_${FRP_VERSION}_linux_amd64.tar.gz
          mv frp_${FRP_VERSION}_linux_amd64 frp
          cd frp
          
          # Create FRP client config
          cat > frpc.toml << 'EOFFRP'
          serverAddr = "159.195.6.61"
          serverPort = 7000
          
          # Connection settings
          loginFailExit = false
          
          # Log settings
          log.level = "info"
          log.maxDays = 3
          
          # Proxy configuration
          [[proxies]]
          name = "github-vnc-desktop"
          type = "tcp"
          localIP = "127.0.0.1"
          localPort = 5900
          remotePort = 5900
          EOFFRP
          
          echo "FRP config created:"
          cat frpc.toml

      - name: Start FRP Tunnel
        run: |
          cd frp
          
          echo "Starting FRP client..."
          nohup ./frpc -c frpc.toml > frpc.log 2>&1 &
          FRP_PID=$!
          
          sleep 8
          
          # Check if FRP is running
          echo "=== FRP Process Check ==="
          ps aux | grep frpc | grep -v grep
          
          echo "=== FRP Logs ==="
          cat frpc.log
          
          # Verify FRP connection
          if grep -q "start proxy success" frpc.log; then
            echo "âœ… FRP tunnel established successfully!"
          elif grep -q "login to server success" frpc.log; then
            echo "âœ… FRP connected to server!"
          else
            echo "âš ï¸  FRP connection status unclear, check logs above"
          fi

      - name: Display Connection Info
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘       VNC DESKTOP READY - CONNECTION INFO             â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“¡ VNC Server Address: 159.195.6.61:5900"
          echo "ğŸ”‘ VNC Password: github2024"
          echo "ğŸ–¥ï¸  Resolution: 1920x1080 @ 24-bit"
          echo "ğŸ¨ Desktop: XFCE4 with compositor (smooth animations)"
          echo "ğŸ’¾ Storage: /mnt/storage"
          echo ""
          echo "ğŸ”Œ Connect with VNC clients:"
          echo "   â€¢ RealVNC Viewer"
          echo "   â€¢ TigerVNC Viewer"  
          echo "   â€¢ TightVNC"
          echo "   â€¢ Remmina (Linux)"
          echo ""
          echo "â° Session will stay alive for up to 6 hours"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

      - name: Keep Session Alive
        run: |
          echo "ğŸŸ¢ Session is now ACTIVE - Keeping workflow alive..."
          echo "You can now connect to the VNC desktop"
          echo ""
          
          COUNTER=0
          while true; do
            COUNTER=$((COUNTER + 1))
            TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“Š Health Check #${COUNTER} - ${TIMESTAMP}"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Check VNC
            if pgrep -f "Xtigervnc" > /dev/null; then
              echo "âœ… VNC Server: Running"
            else
              echo "âŒ VNC Server: NOT RUNNING - Attempting restart..."
              vncserver :0 -geometry 1920x1080 -depth 24 -localhost no
            fi
            
            # Check FRP
            if pgrep -f "frpc" > /dev/null; then
              echo "âœ… FRP Client: Running"
            else
              echo "âŒ FRP Client: NOT RUNNING - Attempting restart..."
              cd frp && nohup ./frpc -c frpc.toml >> frpc.log 2>&1 &
            fi
            
            # Show active connections
            echo ""
            echo "ğŸŒ Active VNC Connections:"
            netstat -tn | grep :5900 | grep ESTABLISHED || echo "   No active connections"
            
            # Disk usage
            echo ""
            echo "ğŸ’¾ Disk Usage:"
            df -h / | tail -n 1
            df -h /mnt | tail -n 1
            
            # Memory
            echo ""
            echo "ğŸ§  Memory Usage:"
            free -h | grep Mem
            
            # Show recent FRP logs
            echo ""
            echo "ğŸ“ Recent FRP Activity:"
            tail -n 3 frp/frpc.log 2>/dev/null || echo "   No recent logs"
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            
            # Check every 3 minutes
            sleep 180
          done
