name: KDE Plasma Desktop VNC with Android Studio

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  kde-desktop:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Storage
        run: |
          sudo mkdir -p /mnt/storage
          sudo chmod 777 /mnt/storage
          mkdir -p /mnt/storage/android-{sdk,avd}

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666"' | sudo tee /etc/udev/rules.d/99-kvm.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          sudo chmod 666 /dev/kvm 2>/dev/null || true

      - name: Install KDE Plasma
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            kde-plasma-desktop konsole dolphin kate firefox \
            tigervnc-standalone-server dbus-x11 \
            openjdk-17-jdk unzip wget curl

      - name: Configure User
        run: |
          echo "runner:github2024" | sudo chpasswd
          mkdir -p ~/.config
          echo -e "[Daemon]
Autolock=false
LockOnResume=false
Timeout=0" > ~/.config/kscreenlockerrc

      - name: Install Android SDK
        run: |
          cd /mnt/storage/android-sdk
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
          unzip -q commandlinetools-linux-*.zip
          mkdir -p cmdline-tools/latest
          mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
          
          export ANDROID_HOME=/mnt/storage/android-sdk
          export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin
          
          yes | cmdline-tools/latest/bin/sdkmanager --licenses
          cmdline-tools/latest/bin/sdkmanager \
            "platform-tools" "platforms;android-34" "build-tools;34.0.0" \
            "emulator" "system-images;android-34;google_apis;x86_64"

      - name: Download Android Studio
        run: |
          cd /mnt/storage
          wget -q https://dl.google.com/android/studio/ide-zips/2024.2.1.12/android-studio-2024.2.1.12-linux.tar.gz
          tar -xzf android-studio-*.tar.gz
          rm android-studio-*.tar.gz

      - name: Configure Android Studio
        run: |
          mkdir -p ~/.config/Google/AndroidStudio{2024.1,2024.2,2025.1}
          for dir in ~/.config/Google/AndroidStudio*; do
            echo -e "android.sdk.path=/mnt/storage/android-sdk
avd.home=/mnt/storage/android-avd" > "$dir/idea.properties"
          done

      - name: Setup Environment
        run: |
          cat > ~/.profile << 'EOF'
          export ANDROID_HOME=/mnt/storage/android-sdk
          export ANDROID_SDK_ROOT=/mnt/storage/android-sdk
          export ANDROID_AVD_HOME=/mnt/storage/android-avd
          export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/emulator
          EOF

      - name: Configure VNC
        run: |
          mkdir -p ~/.vnc
          echo "github2024" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          
          cat > ~/.vnc/xstartup << 'EOF'
          #!/bin/bash
          unset SESSION_MANAGER DBUS_SESSION_BUS_ADDRESS
          [ -z "$DBUS_SESSION_BUS_ADDRESS" ] && eval $(dbus-launch --sh-syntax)
          xsetroot -solid "#1e1e2e"
          [ -f ~/.profile ] && source ~/.profile
          export KDE_SKIP_KSCREENLOCKER=1 XDG_SESSION_TYPE=x11 XDG_CURRENT_DESKTOP=KDE
          startplasma-x11
          EOF
          chmod +x ~/.vnc/xstartup
          
          echo -e "geometry=1920x1080
depth=24
localhost=no
alwaysshared=true" > ~/.vnc/config

      - name: Start VNC
        run: |
          vncserver :0 \
            -geometry 1920x1080 -depth 24 -localhost no \
            -rfbauth ~/.vnc/passwd -SecurityTypes VncAuth \
            -UseBlacklist=0 -BlacklistThreshold=100 -BlacklistTimeout=1
          
          sleep 5
          pgrep -f "Xtigervnc.*:0" || exit 1

      - name: Setup FRP
        run: |
          wget -q https://github.com/fatedier/frp/releases/download/v0.60.0/frp_0.60.0_linux_amd64.tar.gz
          tar -xzf frp_*.tar.gz && mv frp_*_linux_amd64 frp
          
          cat > frp/frpc.toml << 'EOF'
          serverAddr = "159.195.6.61"
          serverPort = 7000
          [[proxies]]
          name = "vnc"
          type = "tcp"
          localIP = "127.0.0.1"
          localPort = 5900
          remotePort = 5900
          EOF
          
          cd frp && nohup ./frpc -c frpc.toml > frpc.log 2>&1 &
          sleep 3

      - name: Display Info
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ðŸ“¡ VNC: 159.195.6.61:5900              â•‘"
          echo "â•‘  ðŸ”‘ Password: github2024                 â•‘"
          echo "â•‘  ðŸš€ Android Studio:                      â•‘"
          echo "â•‘     /mnt/storage/android-studio/bin/studio.sh"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Keep Alive
        run: |
          while true; do
            pgrep -f "Xtigervnc.*:0" || vncserver :0 -geometry 1920x1080 -depth 24 -localhost no -rfbauth ~/.vnc/passwd -SecurityTypes VncAuth -UseBlacklist=0
            pgrep -f "frpc" || (cd frp && nohup ./frpc -c frpc.toml >> frpc.log 2>&1 &)
            echo "âœ… $(date '+%H:%M:%S') - VNC Active | Disk: $(df -h / | tail -1 | awk '{print $5}') | RAM: $(free -h | grep Mem | awk '{print $3}')"
            sleep 180
          done
