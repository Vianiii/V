name: KDE Plasma Desktop VNC with Android Studio

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  kde-desktop:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up /mnt storage
        run: |
          sudo mkdir -p /mnt/storage
          sudo chmod 777 /mnt/storage
          
          # Create Android SDK and AVD directories in /mnt
          mkdir -p /mnt/storage/android-sdk
          mkdir -p /mnt/storage/android-avd
          
          df -h /mnt
          
      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          sudo chmod 666 /dev/kvm 2>/dev/null || true
          ls -la /dev/kvm

      - name: Install KDE Plasma Desktop
        run: |
          echo "Installing KDE Plasma - Most Beautiful Linux Desktop ğŸ¨"
          
          sudo apt-get update
          
          # Install KDE Plasma Desktop with essential apps
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            kde-plasma-desktop \
            plasma-nm \
            plasma-workspace-wayland \
            konsole \
            dolphin \
            kate \
            firefox \
            tigervnc-standalone-server \
            tigervnc-common \
            dbus-x11 \
            fonts-noto-color-emoji \
            wget \
            curl \
            net-tools \
            htop \
            openjdk-17-jdk \
            unzip \
            cpu-checker
          
          echo "âœ… KDE Plasma installed successfully!"

      - name: Install Android Command Line Tools
        run: |
          echo "ğŸ“± Installing Android SDK Command Line Tools..."
          
          cd /mnt/storage/android-sdk
          
          # Download latest command line tools
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdtools.zip
          unzip -q cmdtools.zip
          rm cmdtools.zip
          
          # Organize cmdline-tools structure (required by Android)
          mkdir -p cmdline-tools/latest
          mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
          
          echo "âœ… Android Command Line Tools installed"

      - name: Set Android Environment Variables
        run: |
          # Set environment variables for this session
          echo "export ANDROID_HOME=/mnt/storage/android-sdk" >> $GITHUB_ENV
          echo "export ANDROID_SDK_ROOT=/mnt/storage/android-sdk" >> $GITHUB_ENV
          echo "export ANDROID_AVD_HOME=/mnt/storage/android-avd" >> $GITHUB_ENV
          echo "export PATH=$PATH:/mnt/storage/android-sdk/cmdline-tools/latest/bin:/mnt/storage/android-sdk/platform-tools:/mnt/storage/android-sdk/emulator" >> $GITHUB_ENV
          
          # Also create persistent config for VNC session
          mkdir -p ~/.profile.d
          cat > ~/.profile.d/android.sh << 'EOFENV'
          export ANDROID_HOME=/mnt/storage/android-sdk
          export ANDROID_SDK_ROOT=/mnt/storage/android-sdk
          export ANDROID_AVD_HOME=/mnt/storage/android-avd
          export PATH=$PATH:/mnt/storage/android-sdk/cmdline-tools/latest/bin
          export PATH=$PATH:/mnt/storage/android-sdk/platform-tools
          export PATH=$PATH:/mnt/storage/android-sdk/emulator
          export PATH=$PATH:/mnt/storage/android-sdk/build-tools/34.0.0
          EOFENV
          
          # Source it
          source ~/.profile.d/android.sh
          
          echo "âœ… Android environment variables configured"

      - name: Install Android SDK Components
        run: |
          export ANDROID_HOME=/mnt/storage/android-sdk
          export ANDROID_SDK_ROOT=/mnt/storage/android-sdk
          export PATH=$PATH:/mnt/storage/android-sdk/cmdline-tools/latest/bin
          
          cd /mnt/storage/android-sdk
          
          echo "ğŸ“¦ Installing Android SDK components..."
          
          # Accept licenses
          yes | cmdline-tools/latest/bin/sdkmanager --licenses
          
          # Install essential SDK components
          cmdline-tools/latest/bin/sdkmanager \
            "platform-tools" \
            "platforms;android-34" \
            "platforms;android-33" \
            "build-tools;34.0.0" \
            "emulator" \
            "system-images;android-34;google_apis;x86_64"
          
          echo "âœ… Android SDK components installed"

      - name: Download Android Studio
        run: |
          echo "ğŸ’¿ Downloading Android Studio..."
          
          cd /mnt/storage
          
          # Download latest Android Studio
          wget -q https://redirector.gvt1.com/edgedl/android/studio/ide-zips/2024.2.1.11/android-studio-2024.2.1.11-linux.tar.gz -O android-studio.tar.gz
          
          tar -xzf android-studio.tar.gz
          rm android-studio.tar.gz
          
          echo "âœ… Android Studio downloaded and extracted"

      - name: Configure Android Studio
        run: |
          echo "âš™ï¸ Configuring Android Studio..."
          
          # Create Android Studio config directory
          mkdir -p ~/.config/Google/AndroidStudio2024.2
          
          # Create idea.properties to set custom paths
          cat > ~/.config/Google/AndroidStudio2024.2/idea.properties << 'EOFPROPS'
          # Custom Android SDK location
          android.sdk.path=/mnt/storage/android-sdk
          
          # Custom AVD location
          avd.home=/mnt/storage/android-avd
          EOFPROPS
          
          # Create desktop launcher
          mkdir -p ~/.local/share/applications
          cat > ~/.local/share/applications/android-studio.desktop << 'EOFDESKTOP'
          [Desktop Entry]
          Version=1.0
          Type=Application
          Name=Android Studio
          Icon=/mnt/storage/android-studio/bin/studio.png
          Exec=/mnt/storage/android-studio/bin/studio.sh
          Comment=Android Development IDE
          Categories=Development;IDE;
          Terminal=false
          StartupWMClass=jetbrains-studio
          EOFDESKTOP
          
          chmod +x ~/.local/share/applications/android-studio.desktop
          
          echo "âœ… Android Studio configured"

      - name: Configure VNC for KDE Plasma
        run: |
          mkdir -p ~/.vnc
          
          # VNC password
          echo "github2024" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          
          # Create xstartup for KDE Plasma
          cat > ~/.vnc/xstartup << 'EOFVNC'
          #!/bin/bash
          
          # Unset session managers
          unset SESSION_MANAGER
          unset DBUS_SESSION_BUS_ADDRESS
          
          # Start D-Bus
          if [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then
              eval $(dbus-launch --sh-syntax --exit-with-session)
          fi
          
          # Set background
          xsetroot -solid "#1e1e2e"
          
          # Load Android environment variables
          if [ -f ~/.profile.d/android.sh ]; then
              source ~/.profile.d/android.sh
          fi
          
          # Start KDE Plasma
          export XDG_SESSION_TYPE=x11
          export XDG_SESSION_DESKTOP=KDE
          export XDG_CURRENT_DESKTOP=KDE
          export DESKTOP_SESSION=plasma
          
          # Launch Plasma session
          startplasma-x11
          EOFVNC
          
          chmod +x ~/.vnc/xstartup
          
          # VNC config for best quality
          cat > ~/.vnc/config << 'EOFCONFIG'
          geometry=1920x1080
          dpi=96
          depth=24
          localhost=no
          alwaysshared=true
          EOFCONFIG
          
          echo "âœ… VNC configured for KDE Plasma"

      - name: Start VNC Server
        run: |
          echo "ğŸš€ Starting VNC server with KDE Plasma..."
          
          # Clean up any existing sessions
          vncserver -kill :0 2>/dev/null || true
          rm -f /tmp/.X0-lock /tmp/.X11-unix/X0 2>/dev/null || true
          sleep 2
          
          # Start VNC
          vncserver :0 -geometry 1920x1080 -depth 24 -localhost no
          
          # Wait for VNC to start
          echo "Waiting for VNC initialization..."
          for i in {1..30}; do
            if pgrep -f "Xtigervnc.*:0" > /dev/null; then
              echo "âœ… VNC server started successfully!"
              break
            fi
            sleep 1
          done
          
          # Display status
          echo ""
          echo "=== VNC Status ==="
          pgrep -a "Xtigervnc" || echo "âš ï¸  VNC process not found"
          sudo netstat -tulpn | grep 5900 || echo "âš ï¸  Port 5900 not listening"
          
          # Show logs if available
          if [ -f ~/.vnc/*.log ]; then
            echo ""
            echo "=== VNC Logs ==="
            tail -20 ~/.vnc/*:0.log
          fi

      - name: Verify VNC Running
        run: |
          if ! pgrep -f "Xtigervnc.*:0" > /dev/null; then
            echo "âŒ VNC server failed to start!"
            cat ~/.vnc/*:0.log 2>/dev/null || echo "No logs available"
            exit 1
          fi
          echo "âœ… VNC is running"

      - name: Download and Setup FRP
        run: |
          echo "ğŸ“¡ Setting up FRP tunnel..."
          FRP_VERSION="0.60.0"
          wget -q https://github.com/fatedier/frp/releases/download/v${FRP_VERSION}/frp_${FRP_VERSION}_linux_amd64.tar.gz
          tar -xzf frp_${FRP_VERSION}_linux_amd64.tar.gz
          mv frp_${FRP_VERSION}_linux_amd64 frp
          
          cd frp
          cat > frpc.toml << 'EOFFRP'
          serverAddr = "159.195.6.61"
          serverPort = 7000
          
          log.level = "info"
          
          [[proxies]]
          name = "kde-plasma-vnc"
          type = "tcp"
          localIP = "127.0.0.1"
          localPort = 5900
          remotePort = 5900
          EOFFRP
          
          echo "âœ… FRP configured"

      - name: Start FRP Tunnel
        run: |
          cd frp
          
          echo "ğŸ”Œ Starting FRP tunnel..."
          nohup ./frpc -c frpc.toml > frpc.log 2>&1 &
          
          # Wait for connection
          for i in {1..20}; do
            if grep -q "start proxy success|login to server success" frpc.log 2>/dev/null; then
              echo "âœ… FRP tunnel established!"
              break
            fi
            sleep 1
          done
          
          echo ""
          echo "=== FRP Status ==="
          ps aux | grep frpc | grep -v grep
          cat frpc.log

      - name: Display Connection Info
        run: |
          export ANDROID_HOME=/mnt/storage/android-sdk
          
          # Get disk usage
          SDK_SIZE=$(du -sh /mnt/storage/android-sdk 2>/dev/null | cut -f1)
          AVD_SIZE=$(du -sh /mnt/storage/android-avd 2>/dev/null | cut -f1)
          
          # Check KVM status
          KVM_STATUS="Disabled"
          if [ -e /dev/kvm ]; then
            KVM_STATUS="âœ… Enabled (/dev/kvm)"
          else
            KVM_STATUS="âš ï¸ Not available"
          fi
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘    ğŸ¨ KDE PLASMA + ANDROID STUDIO READY! ğŸ¨          â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                       â•‘"
          echo "â•‘  ğŸ“¡ VNC Address: 159.195.6.61:5900                   â•‘"
          echo "â•‘  ğŸ”‘ Password: github2024                              â•‘"
          echo "â•‘  ğŸ–¥ï¸  Resolution: 1920x1080 Full HD                    â•‘"
          echo "â•‘  ğŸ¨ Desktop: KDE Plasma                               â•‘"
          echo "â•‘                                                       â•‘"
          echo "â•‘  ğŸ“± Android Development:                              â•‘"
          echo "â•‘  â€¢ Android Studio: /mnt/storage/android-studio       â•‘"
          echo "â•‘  â€¢ SDK Location: /mnt/storage/android-sdk ($SDK_SIZE)â•‘"
          echo "â•‘  â€¢ AVD Location: /mnt/storage/android-avd ($AVD_SIZE)â•‘"
          echo "â•‘  â€¢ Platform: Android 34 (API 34)                     â•‘"
          echo "â•‘  â€¢ Emulator: x86_64 system image installed           â•‘"
          echo "â•‘  â€¢ KVM Acceleration: $KVM_STATUS                     â•‘"
          echo "â•‘                                                       â•‘"
          echo "â•‘  ğŸš€ Launch Android Studio:                            â•‘"
          echo "â•‘     /mnt/storage/android-studio/bin/studio.sh        â•‘"
          echo "â•‘                                                       â•‘"
          echo "â•‘  Apps Included:                                       â•‘"
          echo "â•‘  â€¢ Konsole (Terminal)                                 â•‘"
          echo "â•‘  â€¢ Dolphin (File Manager)                             â•‘"
          echo "â•‘  â€¢ Kate (Text Editor)                                 â•‘"
          echo "â•‘  â€¢ Firefox (Web Browser)                              â•‘"
          echo "â•‘                                                       â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "â° Session duration: Up to 6 hours"
          echo ""

      - name: Keep Alive with Monitoring
        run: |
          echo "ğŸŸ¢ KDE PLASMA + ANDROID STUDIO SESSION ACTIVE"
          echo ""
          
          COUNT=0
          while true; do
            COUNT=$((COUNT + 1))
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“Š Status Check #${COUNT} - $(date '+%H:%M:%S')"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Check VNC
            if pgrep -f "Xtigervnc.*:0" > /dev/null; then
              echo "âœ… VNC Server: Active"
            else
              echo "âš ï¸  VNC Server: Restarting..."
              vncserver :0 -geometry 1920x1080 -depth 24 -localhost no
              sleep 3
            fi
            
            # Check FRP
            if pgrep -f "frpc" > /dev/null; then
              echo "âœ… FRP Tunnel: Connected"
            else
              echo "âš ï¸  FRP Tunnel: Reconnecting..."
              cd frp && nohup ./frpc -c frpc.toml >> frpc.log 2>&1 &
              sleep 2
            fi
            
            # Check KDE Plasma processes
            if pgrep -f "plasmashell" > /dev/null; then
              echo "âœ… KDE Plasma: Running"
            else
              echo "â„¹ï¸  KDE Plasma: Starting (will start on first connection)"
            fi
            
            # Check Android Studio
            if pgrep -f "android-studio" > /dev/null; then
              echo "ğŸ“± Android Studio: Running"
            fi
            
            # Check KVM
            if [ -e /dev/kvm ]; then
              echo "âš¡ KVM: Available for emulator acceleration"
            fi
            
            # Active connections
            CONNECTIONS=$(sudo netstat -tn 2>/dev/null | grep :5900 | grep ESTABLISHED | wc -l)
            if [ "$CONNECTIONS" -gt 0 ]; then
              echo "ğŸ‘¥ Active VNC connections: $CONNECTIONS"
            else
              echo "ğŸ‘¤ Waiting for VNC connections..."
            fi
            
            # System resources
            echo "ğŸ’¾ Root: $(df -h / | tail -1 | awk '{print $5 " used"}')"
            echo "ğŸ’¾ /mnt: $(df -h /mnt | tail -1 | awk '{print $5 " used (" $4 " free)"}')"
            echo "ğŸ§  Memory: $(free -h | grep Mem | awk '{print $3 "/" $2}')"
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            
            sleep 180  # Check every 3 minutes
          done
