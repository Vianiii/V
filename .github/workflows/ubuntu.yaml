name: Ubuntu Desktop VNC (Fixed v2)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  ubuntu-desktop:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up /mnt storage
        run: |
          sudo mkdir -p /mnt/storage
          sudo chmod 777 /mnt/storage
          df -h /mnt

      - name: Install Desktop Environment & VNC
        run: |
          echo "Installing desktop environment..."
          sudo apt-get update
          
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 \
            xfce4-goodies \
            xfce4-terminal \
            dbus-x11 \
            x11-xserver-utils \
            tigervnc-standalone-server \
            tigervnc-common \
            tigervnc-xorg-extension \
            fonts-liberation \
            firefox \
            nano \
            net-tools \
            wget \
            curl \
            htop
          
          echo "Installation complete!"

      - name: Configure VNC
        run: |
          mkdir -p ~/.vnc
          
          # Set VNC password
          echo "github2024" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          
          # Create simplified xstartup (more stable)
          cat > ~/.vnc/xstartup << 'EOFVNC'
          #!/bin/sh
          unset SESSION_MANAGER
          unset DBUS_SESSION_BUS_ADDRESS
          
          export XKL_XMODMAP_DISABLE=1
          
          # Start dbus
          if test -z "$DBUS_SESSION_BUS_ADDRESS"; then
              eval `dbus-launch --sh-syntax`
          fi
          
          # Background color
          xsetroot -solid grey -cursor_name left_ptr
          
          # Start window manager first
          xfwm4 --compositor=on --daemon --sm-client-disable
          
          # Start panel and desktop
          xfce4-panel --disable-wm-check --sm-client-disable &
          xfdesktop --disable-wm-check --sm-client-disable &
          
          # Start terminal 
          xfce4-terminal &
          
          # Keep session alive
          exec tail -f /dev/null
          EOFVNC
          
          chmod +x ~/.vnc/xstartup
          
          # VNC config
          cat > ~/.vnc/config << 'EOFCONFIG'
          geometry=1920x1080
          dpi=96
          depth=24
          localhost=no
          alwaysshared=true
          EOFCONFIG
          
          echo "VNC configured"

      - name: Start VNC Server
        run: |
          echo "Starting VNC server..."
          
          # Kill any existing sessions
          vncserver -kill :0 2>/dev/null || true
          rm -f /tmp/.X0-lock /tmp/.X11-unix/X0 2>/dev/null || true
          sleep 2
          
          # Start VNC
          vncserver :0 -geometry 1920x1080 -depth 24 -localhost no 2>&1 | tee vnc_start.log
          
          # Wait for VNC to initialize
          echo "Waiting for VNC to start..."
          for i in {1..30}; do
            if pgrep -f "Xtigervnc.*:0" > /dev/null; then
              echo "âœ… VNC server process found!"
              break
            fi
            echo "Attempt $i/30: Waiting for VNC process..."
            sleep 1
          done
          
          # Final verification
          echo ""
          echo "=== VNC Process Status ==="
          pgrep -a "Xtigervnc" || echo "âŒ No VNC process found"
          
          echo ""
          echo "=== VNC Port Status ==="
          sudo netstat -tulpn | grep 5900 || sudo ss -tulpn | grep 5900 || echo "âš ï¸  Port 5900 not listening"
          
          echo ""
          echo "=== VNC Logs ==="
          ls -la ~/.vnc/
          cat ~/.vnc/*:0.log 2>/dev/null || cat vnc_start.log || echo "No logs available"

      - name: Verify VNC is Running
        run: |
          if ! pgrep -f "Xtigervnc.*:0" > /dev/null; then
            echo "âŒ ERROR: VNC server is not running!"
            echo "Last VNC log:"
            cat ~/.vnc/*:0.log 2>/dev/null || echo "No log file"
            exit 1
          fi
          
          echo "âœ… VNC server is running"
          
          # Test connection locally
          timeout 3 bash -c 'cat < /dev/null > /dev/tcp/127.0.0.1/5900' && echo "âœ… Port 5900 is accepting connections" || echo "âš ï¸  Port test unclear"

      - name: Download and Setup FRP Client
        run: |
          echo "Downloading FRP..."
          FRP_VERSION="0.60.0"
          wget -q https://github.com/fatedier/frp/releases/download/v${FRP_VERSION}/frp_${FRP_VERSION}_linux_amd64.tar.gz
          tar -xzf frp_${FRP_VERSION}_linux_amd64.tar.gz
          mv frp_${FRP_VERSION}_linux_amd64 frp
          cd frp
          
          # Create FRP config
          cat > frpc.toml << 'EOFFRP'
          serverAddr = "159.195.6.61"
          serverPort = 7000
          
          loginFailExit = false
          
          log.level = "info"
          log.maxDays = 3
          
          [[proxies]]
          name = "github-vnc-desktop"
          type = "tcp"
          localIP = "127.0.0.1"
          localPort = 5900
          remotePort = 5900
          EOFFRP
          
          cat frpc.toml

      - name: Start FRP Tunnel
        run: |
          cd frp
          
          echo "Starting FRP tunnel..."
          nohup ./frpc -c frpc.toml > frpc.log 2>&1 &
          FRP_PID=$!
          echo $FRP_PID > frpc.pid
          
          # Wait for FRP to connect
          echo "Waiting for FRP connection..."
          for i in {1..20}; do
            if grep -q "start proxy success|login to server success" frpc.log 2>/dev/null; then
              echo "âœ… FRP connected successfully!"
              break
            fi
            echo "Attempt $i/20: Waiting for FRP..."
            sleep 1
          done
          
          echo ""
          echo "=== FRP Status ==="
          ps aux | grep frpc | grep -v grep
          
          echo ""
          echo "=== FRP Logs ==="
          cat frpc.log

      - name: Connection Ready
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘            ğŸ‰ VNC DESKTOP IS READY! ğŸ‰                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“¡ Connect to: 159.195.6.61:5900"
          echo "ğŸ”‘ Password: github2024"
          echo "ğŸ–¥ï¸  Desktop: XFCE4 (1920x1080)"
          echo "ğŸ’¾ Storage: /mnt/storage"
          echo ""
          echo "VNC Clients: RealVNC, TigerVNC, TightVNC, Remmina"
          echo ""
          echo "â° Session active for up to 6 hours"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Keep Alive & Monitor
        run: |
          echo ""
          echo "ğŸŸ¢ SESSION ACTIVE - Monitoring started"
          echo ""
          
          CHECK=0
          while true; do
            CHECK=$((CHECK + 1))
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“Š Health Check #${CHECK} - $(date '+%H:%M:%S')"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Check VNC
            if pgrep -f "Xtigervnc.*:0" > /dev/null; then
              VNC_PID=$(pgrep -f "Xtigervnc.*:0")
              echo "âœ… VNC Running (PID: $VNC_PID)"
            else
              echo "âŒ VNC NOT RUNNING - Restarting..."
              vncserver :0 -geometry 1920x1080 -depth 24 -localhost no
              sleep 3
            fi
            
            # Check FRP
            if pgrep -f "frpc" > /dev/null; then
              FRP_PID=$(pgrep -f "frpc")
              echo "âœ… FRP Running (PID: $FRP_PID)"
            else
              echo "âŒ FRP NOT RUNNING - Restarting..."
              cd frp && nohup ./frpc -c frpc.toml >> frpc.log 2>&1 &
              sleep 2
            fi
            
            # Show connections
            CONN_COUNT=$(sudo netstat -tn 2>/dev/null | grep :5900 | grep ESTABLISHED | wc -l)
            if [ "$CONN_COUNT" -gt 0 ]; then
              echo "ğŸŒ Active Connections: $CONN_COUNT"
              sudo netstat -tn | grep :5900 | grep ESTABLISHED
            else
              echo "ğŸŒ Active Connections: None"
            fi
            
            # Resources
            echo "ğŸ’¾ Disk: $(df -h / | tail -1 | awk '{print $5 " used"}')"
            echo "ğŸ§  RAM: $(free -h | grep Mem | awk '{print $3 "/" $2}')"
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            
            sleep 180  # Check every 3 minutes
          done
