name: PrimeOS QEMU with VNC and FRP Tunnel

on:
  workflow_dispatch:
    inputs:
      keep_alive_minutes:
        description: 'Keep environment alive (minutes)'
        required: false
        default: '120'
      memory_gb:
        description: 'RAM for QEMU (GB)'
        required: false
        default: '8'

jobs:
  primeos-qemu:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install QEMU and Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qemu-system-x86 \
            qemu-utils \
            qemu-kvm \
            libvirt-clients \
            libvirt-daemon \
            tigervnc-standalone-server \
            tigervnc-viewer \
            x11-apps \
            wget \
            curl \
            net-tools \
            aria2
          
          sudo chmod 666 /dev/kvm
          
          echo "QEMU and dependencies installed successfully"

      - name: Download PrimeOS ISO
        run: |
          mkdir -p ~/primeos_data
          cd ~/primeos_data
          
          echo "Downloading PrimeOS ISO from SourceForge..."
          
          # Method 1: Direct SourceForge download
          wget --continue --timeout=30 -q \
            'https://sourceforge.net/projects/primeos/files/64-bit/PrimeOS-2.1.3-64-bit-20220719-BETA.iso/download' \
            -O primeos.iso 2>&1
          
          ISO_SIZE=$(ls -lh primeos.iso 2>/dev/null | awk '{print $5}')
          
          if [ -f primeos.iso ] && [ $(stat -f%z primeos.iso 2>/dev/null || stat -c%s primeos.iso) -gt 1000000000 ]; then
            echo "âœ“ PrimeOS ISO downloaded successfully: $ISO_SIZE"
          else
            echo "First attempt failed, trying alternative mirror..."
            
            # Method 2: Using aria2 with retry
            aria2c --max-connection-per-server=4 --split=4 --continue=true \
              'https://sourceforge.net/projects/primeos/files/64-bit/PrimeOS-2.1.3-64-bit-20220719-BETA.iso/download' \
              -o primeos.iso 2>&1 || true
            
            if [ ! -f primeos.iso ] || [ $(stat -c%s primeos.iso) -lt 1000000000 ]; then
              echo "Trying compressed/lighter version..."
              wget --continue --timeout=30 -q \
                'https://nchc.dl.sourceforge.net/project/primeos/64-bit/PrimeOS-2.1.3-64-bit-20220719-BETA.iso' \
                -O primeos.iso || true
            fi
          fi
          
          if [ ! -f primeos.iso ] || [ ! -s primeos.iso ]; then
            echo "ERROR: Failed to download PrimeOS ISO"
            echo "Please manually download from: https://sourceforge.net/projects/primeos/"
            echo "And place it in ~/primeos_data/primeos.iso"
            exit 1
          fi
          
          ISO_FINAL_SIZE=$(stat -c%s primeos.iso)
          echo "ISO file size: $ISO_FINAL_SIZE bytes"
          ls -lh primeos.iso

      - name: Create QEMU Virtual Disk
        env:
          MEMORY_GB: ${{ github.event.inputs.memory_gb || '8' }}
        run: |
          cd ~/primeos_data
          
          # Create 50GB virtual disk for PrimeOS
          qemu-img create -f qcow2 primeos.qcow2 50G
          
          echo "Virtual disk created: primeos.qcow2"
          ls -lh primeos.qcow2

      - name: Setup VNC Server
        run: |
          mkdir -p ~/.vnc
          echo "vncpass123" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          
          # Start Xvfb for headless VNC
          Xvfb :1 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          export DISPLAY=:1
          
          # Start VNC server
          vncserver :1 -geometry 1920x1080 -depth 24 -rfbport 5901
          
          sleep 3
          netstat -tuln | grep 590 || echo "VNC starting..."
          echo "VNC server configured on port 5901"

      - name: Download and Setup FRP Client
        env:
          FRP_VERSION: "0.52.3"
        run: |
          mkdir -p ~/frp
          cd ~/frp
          
          wget -q https://github.com/fatedier/frp/releases/download/v${FRP_VERSION}/frp_${FRP_VERSION}_linux_amd64.tar.gz
          tar -xzf frp_${FRP_VERSION}_linux_amd64.tar.gz
          cd frp_${FRP_VERSION}_linux_amd64
          
          cat > frpc.ini << 'EOF'
          [common]
          server_addr = 159.195.6.61
          server_port = 7000
          token = ${{ secrets.FRP_TOKEN }}
          
          [vnc_primeos]
          type = tcp
          local_ip = 127.0.0.1
          local_port = 5901
          remote_port = 5900
          EOF
          
          nohup ./frpc -c frpc.ini > frpc.log 2>&1 &
          sleep 5
          
          echo "FRP Client Started"
          cat frpc.log

      - name: Boot PrimeOS in QEMU with VNC
        env:
          MEMORY_GB: ${{ github.event.inputs.memory_gb || '8' }}
          DISPLAY: :1
        run: |
          cd ~/primeos_data
          
          echo "Starting QEMU with PrimeOS..."
          
          qemu-system-x86_64 \
            -enable-kvm \
            -smp cores=4 \
            -m ${MEMORY_GB}G \
            -hda primeos.qcow2 \
            -cdrom primeos.iso \
            -boot d \
            -vnc :0 \
            -no-reboot \
            -usb \
            -net nic,model=virtio \
            -net user,hostfwd=tcp::5555-:5555 \
            -display none \
            -daemonize \
            -pidfile qemu.pid
          
          sleep 15
          
          # Verify QEMU started
          if [ -f qemu.pid ]; then
            PID=$(cat qemu.pid)
            if ps -p $PID > /dev/null; then
              echo "âœ“ QEMU running with PID: $PID"
            else
              echo "ERROR: QEMU failed to start"
              exit 1
            fi
          fi
          
          netstat -tuln | grep -E '5900|590' || echo "VNC ports checking..."

      - name: Wait for PrimeOS to Boot
        run: |
          echo "Waiting for PrimeOS to boot (90 seconds)..."
          for i in {1..90}; do
            sleep 1
            echo -n "."
          done
          echo ""
          echo "Boot sequence complete"
          
          ps aux | grep qemu | grep -v grep || echo "QEMU status check failed"

      - name: Display Connection Information
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘    PrimeOS QEMU + VNC + FRP Setup        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ–¥ï¸  VNC CONNECTION:"
          echo "   Server:   159.195.6.61"
          echo "   Port:     5900"
          echo "   Password: vncpass123"
          echo ""
          echo "ğŸ“± PRIMEOS FEATURES:"
          echo "   âœ“ Full Android Desktop"
          echo "   âœ“ Google Play Store (pre-installed)"
          echo "   âœ“ Root Access (su command)"
          echo "   âœ“ GameGuardian Ready"
          echo "   âœ“ Game Controller Support"
          echo ""
          echo "â±ï¸  DURATION: ${{ github.event.inputs.keep_alive_minutes }} minutes"
          echo "ğŸ’¾ RAM: ${{ github.event.inputs.memory_gb }}GB"
          echo ""
          
          netstat -tuln | grep LISTEN | awk '{print "   " $4}'

      - name: Keep Environment Alive
        run: |
          KEEP_ALIVE=${{ github.event.inputs.keep_alive_minutes || '120' }}
          echo "Environment running for ${KEEP_ALIVE} minutes..."
          sleep $((KEEP_ALIVE * 60))

      - name: Cleanup
        if: always()
        run: |
          echo "Shutting down..."
          
          # Kill QEMU
          pkill -15 qemu-system || true
          sleep 5
          pkill -9 qemu-system || true
          
          # Kill VNC
          vncserver -kill :1 || true
          pkill -9 Xvfb || true
          
          # Kill FRP
          pkill -f frpc || true
          
          echo "Cleanup completed"
