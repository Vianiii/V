name: PrimeOS QEMU with VNC and FRP Tunnel

on:
  workflow_dispatch:
    inputs:
      keep_alive_minutes:
        description: 'Keep environment alive (minutes)'
        required: false
        default: '120'
      memory_gb:
        description: 'RAM for QEMU (GB)'
        required: false
        default: '8'

jobs:
  primeos-qemu:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install QEMU and Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qemu-system-x86 \
            qemu-utils \
            qemu-kvm \
            libvirt-clients \
            libvirt-daemon \
            tigervnc-standalone-server \
            tigervnc-viewer \
            x11-apps \
            wget \
            curl \
            net-tools \
            dnsmasq \
            bridge-utils
          
          # Enable KVM access
          sudo chmod 666 /dev/kvm
          
          echo "QEMU and dependencies installed successfully"

      - name: Download PrimeOS ISO
        run: |
          mkdir -p ~/primeos_data
          cd ~/primeos_data
          
          echo "Downloading PrimeOS ISO..."
          wget -q https://primeos.in/downloads/PrimeOS_11_x86_64.iso -O primeos.iso
          
          # If official download fails, try alternative source
          if [ ! -f primeos.iso ] || [ ! -s primeos.iso ]; then
            echo "Trying alternative source..."
            wget -q https://nchc.dl.sourceforge.net/project/primeos/PrimeOS_11_x86_64.iso -O primeos.iso
          fi
          
          ls -lh primeos.iso
          echo "PrimeOS ISO ready"

      - name: Create QEMU Virtual Disk
        env:
          MEMORY_GB: ${{ github.event.inputs.memory_gb || '8' }}
        run: |
          cd ~/primeos_data
          
          # Create 50GB virtual disk
          qemu-img create -f qcow2 primeos.qcow2 50G
          
          echo "Virtual disk created: primeos.qcow2"
          ls -lh primeos.qcow2

      - name: Setup VNC Server
        run: |
          mkdir -p ~/.vnc
          echo "vncpass123" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          
          # Start Xvfb (virtual framebuffer) for headless display
          Xvfb :1 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          export DISPLAY=:1
          
          # Start X11 VNC server
          vncserver :1 -geometry 1920x1080 -depth 24 -rfbport 5901
          
          sleep 3
          netstat -tuln | grep 590
          echo "VNC server started on port 5901"

      - name: Download and Setup FRP Client
        env:
          FRP_VERSION: "0.52.3"
        run: |
          mkdir -p ~/frp
          cd ~/frp
          
          # Download FRP
          wget -q https://github.com/fatedier/frp/releases/download/v${FRP_VERSION}/frp_${FRP_VERSION}_linux_amd64.tar.gz
          tar -xzf frp_${FRP_VERSION}_linux_amd64.tar.gz
          cd frp_${FRP_VERSION}_linux_amd64
          
          # Create FRP config for VNC tunneling
          cat > frpc.ini << 'EOF'
          [common]
          server_addr = 159.195.6.61
          server_port = 7000
          token = ${{ secrets.FRP_TOKEN }}
          
          [vnc_primeos]
          type = tcp
          local_ip = 127.0.0.1
          local_port = 5901
          remote_port = 5900
          use_encryption = false
          use_compression = false
          EOF
          
          # Start FRP client
          nohup ./frpc -c frpc.ini > frpc.log 2>&1 &
          sleep 5
          
          echo "FRP Client Configuration:"
          cat frpc.ini
          echo ""
          echo "FRP Client Started"
          cat frpc.log

      - name: Boot PrimeOS in QEMU with VNC
        env:
          MEMORY_GB: ${{ github.event.inputs.memory_gb || '8' }}
          DISPLAY: :1
        run: |
          cd ~/primeos_data
          
          # Start QEMU with PrimeOS and VNC display
          qemu-system-x86_64 \
            -enable-kvm \
            -smp cores=4 \
            -m ${MEMORY_GB}G \
            -hda primeos.qcow2 \
            -cdrom primeos.iso \
            -boot d \
            -vnc localhost:0 \
            -no-reboot \
            -usb \
            -device qemu-xhci,id=xhci \
            -net nic,model=virtio \
            -net user,hostfwd=tcp::5555-:5555 \
            -display none \
            -daemonize \
            -pidfile qemu.pid
          
          sleep 10
          
          # Verify QEMU is running
          ps aux | grep qemu
          netstat -tuln | grep 590
          
          echo "QEMU booting PrimeOS..."
          echo "VNC accessible at 159.195.6.61:5900 via FRP tunnel"

      - name: Wait for PrimeOS Boot
        run: |
          echo "Waiting for PrimeOS to fully boot (60 seconds)..."
          sleep 60
          
          echo "Checking QEMU status..."
          ps aux | grep -E 'qemu|vnc' | grep -v grep
          
          netstat -tuln | grep -E '590|7000'

      - name: Install GameGuardian and Tools in PrimeOS
        run: |
          # Note: This requires PrimeOS to be fully booted and accepting connections
          
          cat > ~/install_apps.sh << 'EOF'
          #!/bin/bash
          
          # Wait for ADB connection (if needed)
          sleep 30
          
          # Download GameGuardian APK
          wget -O /tmp/gameguardian.apk "https://gameguardian.net/download/GameGuardian_101.0.apk"
          
          # Since we're in QEMU PrimeOS, the app would be installed through the UI
          # Or via Play Store which is pre-installed
          
          echo "GameGuardian APK ready at /tmp/gameguardian.apk"
          echo "You can install it through PrimeOS UI or Play Store"
          EOF
          
          bash ~/install_apps.sh
          echo "App preparation complete"

      - name: Display Connection Information
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   PrimeOS QEMU + VNC + FRP Setup     â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ“± VNC CONNECTION DETAILS:"
          echo "   Server:  159.195.6.61"
          echo "   Port:    5900"
          echo "   Password: vncpass123"
          echo ""
          echo "ðŸ’» VNC VIEWERS:"
          echo "   â€¢ TightVNC (Windows/Mac)"
          echo "   â€¢ RealVNC (Windows/Mac)"
          echo "   â€¢ VNC Viewer (Linux/Mac/Windows)"
          echo "   â€¢ TigerVNC (Linux)"
          echo ""
          echo "ðŸ“Š FRP TUNNEL:"
          echo "   Local Port:  5901"
          echo "   Remote Port: 5900"
          echo "   Server:      159.195.6.61:7000"
          echo ""
          echo "ðŸŽ® PRIMEOS FEATURES:"
          echo "   âœ“ Full Desktop Environment"
          echo "   âœ“ Play Store (pre-installed)"
          echo "   âœ“ Root Access (su) Available"
          echo "   âœ“ GameGuardian Ready"
          echo "   âœ“ Custom Key Mapping for Games"
          echo ""
          echo "â±ï¸  ENVIRONMENT KEEPALIVE:"
          echo "   Duration: ${{ github.event.inputs.keep_alive_minutes }} minutes"
          echo "   RAM:      ${{ github.event.inputs.memory_gb }}GB"
          echo ""
          
          # Display active services
          echo "ðŸ” ACTIVE SERVICES:"
          netstat -tuln | grep -E 'LISTEN' | awk '{print "   " $4 " " $7}'
          
          ps aux | grep -E 'qemu|vnc|frp' | grep -v grep | awk '{print "   Process: " $11 " " $12}'

      - name: Keep Environment Alive
        run: |
          KEEP_ALIVE=${{ github.event.inputs.keep_alive_minutes || '120' }}
          echo "Environment will stay alive for ${KEEP_ALIVE} minutes"
          echo "Connect now to VNC at 159.195.6.61:5900"
          
          # Keep the job running
          sleep $((KEEP_ALIVE * 60))
          
          echo "Keep-alive period ended"

      - name: Cleanup and Shutdown
        if: always()
        run: |
          echo "Shutting down QEMU..."
          
          # Kill QEMU gracefully
          pkill -15 qemu-system
          sleep 10
          
          # Force kill if still running
          pkill -9 qemu-system || true
          
          # Stop VNC servers
          vncserver -kill :1 || true
          pkill -9 Xvfb || true
          
          # Stop FRP client
          pkill -f frpc || true
          
          # Cleanup
          rm -rf ~/primeos_data ~/frp ~/.vnc
          
          echo "Cleanup completed"
