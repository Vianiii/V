name: PrimeOS QEMU with VNC and FRP Tunnel

on:
  workflow_dispatch:
    inputs:
      keep_alive_minutes:
        description: 'Keep environment alive (minutes)'
        required: false
        default: '120'
      memory_gb:
        description: 'RAM for QEMU (GB)'
        required: false
        default: '8'

jobs:
  primeos-qemu:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install QEMU and Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qemu-system-x86 \
            qemu-utils \
            qemu-kvm \
            tigervnc-standalone-server \
            x11-apps \
            wget \
            curl \
            net-tools
          
          sudo chmod 666 /dev/kvm
          echo "âœ“ QEMU and dependencies installed"

      - name: Download PrimeOS ISO
        run: |
          mkdir -p ~/primeos_data
          cd ~/primeos_data
          
          echo "Downloading PrimeOS ISO..."
          wget --continue --timeout=30 -q \
            'https://sourceforge.net/projects/primeos/files/64-bit/PrimeOS-2.1.3-64-bit-20220719-BETA.iso/download' \
            -O primeos.iso 2>&1
          
          ISO_SIZE=$(stat -c%s primeos.iso)
          if [ $ISO_SIZE -gt 1000000000 ]; then
            echo "âœ“ PrimeOS ISO downloaded: $(numfmt --to=iec $ISO_SIZE)"
          else
            echo "ERROR: ISO download failed"
            exit 1
          fi

      - name: Create QEMU Virtual Disk
        run: |
          cd ~/primeos_data
          qemu-img create -f qcow2 primeos.qcow2 50G
          echo "âœ“ Virtual disk created (50GB)"

      - name: Download and Setup FRP Client
        env:
          FRP_VERSION: "0.52.3"
        run: |
          mkdir -p ~/frp
          cd ~/frp
          
          wget -q https://github.com/fatedier/frp/releases/download/v${FRP_VERSION}/frp_${FRP_VERSION}_linux_amd64.tar.gz
          tar -xzf frp_${FRP_VERSION}_linux_amd64.tar.gz
          cd frp_${FRP_VERSION}_linux_amd64
          
          cat > frpc.ini << 'EOF'
          [common]
          server_addr = 159.195.6.61
          server_port = 7000
          token = ${{ secrets.FRP_TOKEN }}
          
          [vnc_primeos]
          type = tcp
          local_ip = 127.0.0.1
          local_port = 5900
          remote_port = 5900
          EOF
          
          nohup ./frpc -c frpc.ini > frpc.log 2>&1 &
          sleep 3
          echo "âœ“ FRP Client Started"

      - name: Boot PrimeOS in QEMU with VNC
        env:
          MEMORY_GB: ${{ github.event.inputs.memory_gb || '8' }}
        run: |
          cd ~/primeos_data
          
          # Start QEMU with native VNC display (port 5900)
          qemu-system-x86_64 \
            -enable-kvm \
            -smp cores=4 \
            -m ${MEMORY_GB}G \
            -hda primeos.qcow2 \
            -cdrom primeos.iso \
            -boot d \
            -vnc 127.0.0.1:0 \
            -no-reboot \
            -usb \
            -device qemu-xhci,id=xhci \
            -net nic,model=virtio \
            -net user,hostfwd=tcp::5555-:5555 \
            -daemonize \
            -pidfile qemu.pid
          
          sleep 10
          
          # Verify QEMU started
          if [ -f qemu.pid ]; then
            PID=$(cat qemu.pid)
            if ps -p $PID > /dev/null 2>&1; then
              echo "âœ“ QEMU running (PID: $PID)"
              ps -p $PID
            else
              echo "âœ— QEMU failed to start"
              exit 1
            fi
          fi
          
          # Check VNC port
          netstat -tuln | grep 590 || echo "Checking VNC..."

      - name: Wait for PrimeOS Boot
        run: |
          echo "Waiting for PrimeOS to boot..."
          for i in {1..120}; do
            if netstat -tuln 2>/dev/null | grep -q ':5900'; then
              echo "âœ“ VNC port available after $i seconds"
              sleep 5
              break
            fi
            sleep 1
            if [ $((i % 10)) -eq 0 ]; then echo "$i seconds..."; fi
          done
          
          netstat -tuln | grep 5900 || echo "VNC monitoring..."

      - name: Display Connection Information
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   PrimeOS QEMU Ready for Connection   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ–¥ï¸  VNC CONNECTION DETAILS:"
          echo "   Server:   159.195.6.61"
          echo "   Port:     5900"
          echo "   Password: (none - open)"
          echo ""
          echo "ğŸ“± FEATURES AVAILABLE:"
          echo "   âœ“ Full PrimeOS Desktop"
          echo "   âœ“ Google Play Store"
          echo "   âœ“ Root Access (su)"
          echo "   âœ“ GameGuardian Compatible"
          echo ""
          echo "â±ï¸  CONFIGURATION:"
          echo "   RAM:      ${{ github.event.inputs.memory_gb }}GB"
          echo "   Duration: ${{ github.event.inputs.keep_alive_minutes }} minutes"
          echo "   Cores:    4 vCPU"
          echo ""
          echo "ğŸ“¥ CONNECTED SERVICES:"
          netstat -tuln | grep LISTEN | grep -E '590|7000' | \
            sed 's/^/   /'
          echo ""
          echo "âœ¨ INSTALLATION NEXT STEPS:"
          echo "   1. Connect via VNC at 159.195.6.61:5900"
          echo "   2. Complete PrimeOS setup wizard"
          echo "   3. Install GameGuardian from Play Store"
          echo "   4. Open Terminal and use 'su' for root"
          echo ""

      - name: Keep Environment Alive
        run: |
          KEEP_ALIVE=${{ github.event.inputs.keep_alive_minutes || '120' }}
          echo "Environment will remain active for ${KEEP_ALIVE} minutes"
          echo "VNC Server: 159.195.6.61:5900"
          echo ""
          sleep $((KEEP_ALIVE * 60))

      - name: Shutdown QEMU
        if: always()
        run: |
          echo "Initiating shutdown..."
          
          # Kill QEMU gracefully
          pkill -15 qemu-system-x86_64 || true
          sleep 5
          
          # Force kill if needed
          pkill -9 qemu-system-x86_64 || true
          
          # Kill FRP
          pkill -f frpc || true
          
          # Cleanup
          rm -rf ~/primeos_data ~/frp
          
          echo "âœ“ Shutdown complete"
