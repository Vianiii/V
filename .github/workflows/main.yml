name: PrimeOS QEMU with VNC and FRP Tunnel

on:
  workflow_dispatch:
    inputs:
      keep_alive_minutes:
        description: 'Keep environment alive (minutes)'
        required: false
        default: '120'
      memory_gb:
        description: 'RAM for QEMU (GB)'
        required: false
        default: '8'

jobs:
  primeos-qemu:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install QEMU and Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qemu-system-x86 \
            qemu-utils \
            qemu-kvm \
            tigervnc-standalone-server \
            x11-apps \
            wget \
            curl \
            net-tools \
            socat
          
          sudo chmod 666 /dev/kvm
          echo "âœ“ QEMU and dependencies installed"

      - name: Download PrimeOS ISO
        run: |
          mkdir -p ~/primeos_data
          cd ~/primeos_data
          
          echo "Downloading PrimeOS ISO..."
          wget --continue --timeout=30 -q \
            'https://sourceforge.net/projects/primeos/files/64-bit/PrimeOS-2.1.3-64-bit-20220719-BETA.iso/download' \
            -O primeos.iso 2>&1
          
          ISO_SIZE=$(stat -c%s primeos.iso)
          if [ $ISO_SIZE -gt 1000000000 ]; then
            echo "âœ“ PrimeOS ISO downloaded: $(numfmt --to=iec $ISO_SIZE)"
          else
            echo "ERROR: ISO download failed"
            exit 1
          fi

      - name: Create QEMU Virtual Disk
        run: |
          cd ~/primeos_data
          qemu-img create -f qcow2 primeos.qcow2 50G
          echo "âœ“ Virtual disk created (50GB)"

      - name: Download and Setup FRP Client
        env:
          FRP_VERSION: "0.52.3"
        run: |
          mkdir -p ~/frp
          cd ~/frp
          
          wget -q https://github.com/fatedier/frp/releases/download/v${FRP_VERSION}/frp_${FRP_VERSION}_linux_amd64.tar.gz
          tar -xzf frp_${FRP_VERSION}_linux_amd64.tar.gz
          cd frp_${FRP_VERSION}_linux_amd64
          
          cat > frpc.ini << 'EOF'
          [common]
          server_addr = 159.195.6.61
          server_port = 7000
          token = ${{ secrets.FRP_TOKEN }}
          
          [vnc_primeos]
          type = tcp
          local_ip = 127.0.0.1
          local_port = 5900
          remote_port = 5900
          EOF
          
          nohup ./frpc -c frpc.ini > frpc.log 2>&1 &
          sleep 3
          echo "âœ“ FRP Client Started"

      - name: Boot PrimeOS in QEMU (Installation Mode)
        env:
          MEMORY_GB: ${{ github.event.inputs.memory_gb || '8' }}
        run: |
          cd ~/primeos_data
          
          echo "Starting QEMU for PrimeOS installation..."
          
          # Boot from ISO for installation
          qemu-system-x86_64 \
            -enable-kvm \
            -smp cores=4 \
            -m ${MEMORY_GB}G \
            -hda primeos.qcow2 \
            -cdrom primeos.iso \
            -boot d \
            -vnc 127.0.0.1:0 \
            -no-reboot \
            -usb \
            -device qemu-xhci,id=xhci \
            -net nic,model=virtio \
            -net user,hostfwd=tcp::5555-:5555 \
            -monitor unix:/tmp/qemu-monitor,server,nowait \
            -daemonize \
            -pidfile qemu.pid
          
          sleep 15
          
          if [ -f qemu.pid ]; then
            PID=$(cat qemu.pid)
            if ps -p $PID > /dev/null 2>&1; then
              echo "âœ“ QEMU running (PID: $PID)"
            else
              echo "ERROR: QEMU failed to start"
              exit 1
            fi
          fi

      - name: Wait for PrimeOS Installation (Watch for Reboot)
        run: |
          echo "Waiting for installation and automatic reboot..."
          
          # Wait for installation to complete and system to shutdown
          sleep 180  # 3 minutes for installation
          
          echo "Installation should be complete"

      - name: Boot PrimeOS from Installed Disk
        env:
          MEMORY_GB: ${{ github.event.inputs.memory_gb || '8' }}
        run: |
          cd ~/primeos_data
          
          echo "Killing previous QEMU instance..."
          pkill -9 qemu-system || true
          sleep 5
          
          echo "Starting QEMU from installed disk (boot from HDD)..."
          
          # Boot from virtual disk (no CD)
          qemu-system-x86_64 \
            -enable-kvm \
            -smp cores=4 \
            -m ${MEMORY_GB}G \
            -hda primeos.qcow2 \
            -boot c \
            -vnc 127.0.0.1:0 \
            -no-reboot \
            -usb \
            -device qemu-xhci,id=xhci \
            -net nic,model=virtio \
            -net user,hostfwd=tcp::5555-:5555 \
            -daemonize \
            -pidfile qemu.pid
          
          sleep 10
          
          if [ -f qemu.pid ]; then
            PID=$(cat qemu.pid)
            if ps -p $PID > /dev/null 2>&1; then
              echo "âœ“ QEMU running from disk (PID: $PID)"
            else
              echo "ERROR: QEMU failed to boot from disk"
              exit 1
            fi
          fi

      - name: Wait for PrimeOS Desktop to Load
        run: |
          echo "Waiting for PrimeOS desktop to fully load (120 seconds)..."
          
          for i in {1..120}; do
            if netstat -tuln 2>/dev/null | grep -q ':5900'; then
              sleep 5
              echo "âœ“ VNC ready after $i seconds"
              break
            fi
            sleep 1
            if [ $((i % 30)) -eq 0 ]; then echo "$i seconds elapsed..."; fi
          done

      - name: Display Connection Information
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   PrimeOS Full Installation Complete!     â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ–¥ï¸  VNC CONNECTION DETAILS:"
          echo "   Server:   159.195.6.61"
          echo "   Port:     5900"
          echo "   Password: (none - open connection)"
          echo ""
          echo "ğŸ“± FEATURES NOW AVAILABLE:"
          echo "   âœ“ Full PrimeOS Installed"
          echo "   âœ“ Persistent 50GB Storage"
          echo "   âœ“ Google Play Store"
          echo "   âœ“ Root Access (su command)"
          echo "   âœ“ GameGuardian Ready"
          echo ""
          echo "â±ï¸  CONFIGURATION:"
          echo "   RAM:      ${{ github.event.inputs.memory_gb }}GB"
          echo "   Duration: ${{ github.event.inputs.keep_alive_minutes }} minutes"
          echo "   Cores:    4 vCPU"
          echo ""
          echo "ğŸ“¥ NEXT STEPS:"
          echo "   1. Connect via VNC to 159.195.6.61:5900"
          echo "   2. Complete PrimeOS first-boot setup"
          echo "   3. Open Play Store and search 'GameGuardian'"
          echo "   4. Open Terminal and type: su"
          echo "   5. You now have full root access!"
          echo ""

      - name: Keep Environment Alive
        run: |
          KEEP_ALIVE=${{ github.event.inputs.keep_alive_minutes || '120' }}
          echo "Environment will remain active for ${KEEP_ALIVE} minutes"
          echo "Connect to VNC: 159.195.6.61:5900"
          sleep $((KEEP_ALIVE * 60))

      - name: Shutdown QEMU
        if: always()
        run: |
          echo "Shutting down..."
          
          # Kill QEMU gracefully
          pkill -15 qemu-system || true
          sleep 5
          
          # Force kill
          pkill -9 qemu-system || true
          
          # Kill FRP
          pkill -f frpc || true
          
          # Cleanup
          rm -rf ~/frp
          
          echo "âœ“ Shutdown complete"
